<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GetVersionedFiles.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">danger-modules-report</a> &gt; <a href="index.source.html" class="el_package">com.sebastmar.module.report.internal.domain</a> &gt; <span class="el_source">GetVersionedFiles.kt</span></div><h1>GetVersionedFiles.kt</h1><pre class="source lang-java linenums">package com.sebastmar.module.report.internal.domain

import com.sebastmar.module.report.info.VersionedFile
import com.sebastmar.module.report.info.VersionedFile.Status
import com.sebastmar.module.report.internal.ShowLineIndicators
import com.sebastmar.module.report.internal.system.SystemCommandLine
import com.sebastmar.module.report.internal.system.SystemWrapper
import java.nio.file.Path
import kotlin.io.path.pathString

/**
 * Maps a list of file paths to a list of [VersionedFile] objects.
 */
internal interface GetVersionedFiles {
    operator fun invoke(
        files: List&lt;String&gt;,
        status: Status,
    ): List&lt;VersionedFile&gt;
}

<span class="fc" id="L21">internal class GetVersionedFilesImpl(</span>
<span class="fc" id="L22">    private val systemCommandLine: SystemCommandLine,</span>
<span class="fc" id="L23">    private val getProjectRoot: GetProjectRoot,</span>
<span class="fc" id="L24">    private val showLineIndicators: ShowLineIndicators,</span>
<span class="fc" id="L25">    private val systemWrapper: SystemWrapper,</span>
) : GetVersionedFiles {

<span class="fc" id="L28">    private val regex by lazy {</span>
<span class="fc" id="L29">        &quot;&quot;&quot;1 file changed, (?:(\d+)\s+insertions\(\+\))?(?:,\s*)?(?:(\d+)\s+deletions\(-\))?&quot;&quot;&quot;.toRegex()</span>
    }

<span class="fc" id="L32">    private val projectRoot: Path by lazy { getProjectRoot() }</span>

    override operator fun invoke(
        files: List&lt;String&gt;,
        status: Status,
    ): List&lt;VersionedFile&gt; {
<span class="fc" id="L38">        return files.map { filePath -&gt;</span>
<span class="fc" id="L39">            val fullPath = filePath.removePrefix(&quot;'a/' --dst-prefix='b/'&quot;)</span>
<span class="fc" id="L40">            val fileName = fullPath.substringAfterLast(&quot;/&quot;)</span>
<span class="fc" id="L41">            var insertions: Int? = null</span>
<span class="fc" id="L42">            var deletions: Int? = null</span>

<span class="fc bfc" id="L44" title="All 2 branches covered.">            if (showLineIndicators.value) {</span>
<span class="fc" id="L45">                val diffShortStat = runDiffStat(fullPath)</span>
<span class="fc" id="L46">                val diffResult = regex.find(diffShortStat)</span>

<span class="fc bfc" id="L48" title="All 2 branches covered.">                if (diffResult != null) {</span>
<span class="fc bfc" id="L49" title="All 4 branches covered.">                    insertions = diffResult.groups[1]?.value?.toIntOrNull()</span>
<span class="fc bfc" id="L50" title="All 4 branches covered.">                    deletions = diffResult.groups[2]?.value?.toIntOrNull()</span>
                }
            }

<span class="fc" id="L54">            VersionedFile(</span>
<span class="fc" id="L55">                name = fileName,</span>
<span class="fc" id="L56">                fullPath = fullPath,</span>
<span class="fc" id="L57">                insertions = insertions,</span>
<span class="fc" id="L58">                deletions = deletions,</span>
<span class="fc" id="L59">                status = status,</span>
<span class="fc" id="L60">            )</span>
        }
    }

    /**
     * Executes a git diff command to get the short statistics for a specific file.
     *
     * The command compares the current state of the file against the target branch,
     * returning information about insertions and deletions.
     *
     * @param fullPath The path to the file relative to the project root.
     * @return A string containing the git diff shortstat output, which includes the number
     *         of insertions and deletions in the format:
     *         &quot;1 file changed, X insertions(+), Y deletions(-)&quot;
     */
    private fun runDiffStat(fullPath: String): String {
<span class="fc" id="L76">        val targetSHA = systemWrapper.targetSHA()</span>
<span class="fc" id="L77">        return systemCommandLine.exec(&quot;git diff --shortstat $targetSHA -- ${projectRoot.pathString}/$fullPath&quot;)</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>